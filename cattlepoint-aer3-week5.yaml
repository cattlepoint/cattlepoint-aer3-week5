---
AWSTemplateFormatVersion: "2010-09-09"
Description: Spot-based Ephemeral Auto Recovery via ASG instance in an **IPv6-only** VPC

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName
  VPCIpv6Cidr:
    Type: AWS::EC2::VPCCidrBlock
    Properties:
      VpcId: !Ref VPC
      AmazonProvidedIpv6CidrBlock: true

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  VpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    DependsOn: VPCIpv6Cidr
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      Ipv6Native: true
      AssignIpv6AddressOnCreation: true
      Ipv6CidrBlock: !Select
        - 0
        - !Cidr
          - !Select [0, !GetAtt VPC.Ipv6CidrBlocks]
          - 2
          - 64
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    DependsOn: VPCIpv6Cidr
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      Ipv6Native: true
      AssignIpv6AddressOnCreation: true
      Ipv6CidrBlock: !Select
        - 1
        - !Cidr
          - !Select [0, !GetAtt VPC.Ipv6CidrBlocks]
          - 2
          - 64
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: VpcGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationIpv6CidrBlock: ::/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref RouteTable

  SubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref RouteTable

  InstanceSecurityGroupA:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SSH from Starlink IPV6 addresses
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2a0d:3340::/29
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2406:2d40::/32
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2c0f:2a80::/32
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2803:9810::/32
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2605:59c0::/28
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2606:ee40::/32
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2620:134:B000::/40
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  InstanceSecurityGroupB:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SSH from T-Mobile USA IPV6 addresses
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2607:FB90::/28
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  InstanceSecurityGroupC:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SSH from AT&T Wireless IPV6 addresses
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: 2600:300::/24
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt"
      LaunchTemplateData:
        InstanceType: t4g.nano
        ImageId: "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64}}"
        UserData:
          Fn::Base64: |
            #!/bin/bash -xe
            dnf update -y
            dnf install -y python3.12 python3.12-pip python3-virtualenv
            /usr/bin/python3.12 -m pip install virtualenvwrapper
            echo "export AWS_USE_DUALSTACK_ENDPOINT=true" >> /home/ec2-user/.bashrc
            echo "export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3.12" >> /home/ec2-user/.bashrc
            echo "source /usr/local/bin/virtualenvwrapper.sh" >> /home/ec2-user/.bashrc
            dnf install docker git -y
            systemctl enable --now docker
            usermod -aG docker ec2-user
            curl -L https://github.com/docker/compose/releases/download/v2.26.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
        InstanceMarketOptions:
          MarketType: spot
          SpotOptions:
            InstanceInterruptionBehavior: terminate
        SecurityGroupIds:
          - !Ref InstanceSecurityGroupA
          - !Ref InstanceSecurityGroupB
          - !Ref InstanceSecurityGroupC
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 10
              VolumeType: gp3
              DeleteOnTermination: true
        IamInstanceProfile:
          Arn: !GetAtt InstanceProfile.Arn
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Ref AWS::StackName
              - Key: Project
                Value: !Ref AWS::StackName
      TagSpecifications:
        - ResourceType: launch-template
          Tags:
            - Key: Name
              Value: !Ref AWS::StackName
            - Key: Project
              Value: !Ref AWS::StackName

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 1
      MaxSize: 1
      DesiredCapacity: 1
      HealthCheckType: EBS
      HealthCheckGracePeriod: 60
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
          PropagateAtLaunch: true
        - Key: Project
          Value: !Ref AWS::StackName
          PropagateAtLaunch: true

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/EC2InstanceConnect
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/ReadOnlyAccess
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
        - Key: Project
          Value: !Ref AWS::StackName

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole
